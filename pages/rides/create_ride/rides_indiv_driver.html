<!DOCTYPE html>

<!-- note to self to get some changes in the rides indiv driver
        1. SMU where? scis? soe? sol?
        2. Interactive? or make it next page?
        3. Maybe put in where the default locations are actually at
        4. this html is from the driver's perspective
    -->

<head>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <!-- <script src="asset/public.js?version={{lastModifiedDate('asset/public.js')}}"></script> -->
    
    <script>
        function lastModifiedDate(url) {
        try {
            var req = new XMLHttpRequest();
            req.open("HEAD", url, false);
            req.send(null);
            if (req.status == 200) {
                return req.getResponseHeader('Last-Modified');
            }
            else return false;
        } catch (er) {
            return er.message;
        }
    }
    </script>

    
    <link rel="stylesheet" href="../../../main.css" />
    <style>
        select,
        option {
            width: 200px;
        }

        #map {
            height: 500px;
            width: auto;
            margin-bottom: 50px;
            border-radius: 20px;
        }

        #problematic {
            display: block;
            justify-content: center;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        }

        .alert-info {
            padding: 20px;
            height: auto;
            width: auto;
            margin-bottom: 40px;
            border-radius: 20px;
        }

        .group {
            position: relative;
            margin-bottom: 60px;
        }

        .other-group {
            position: relative;
            margin-top: -30px;
            margin-bottom: 60px;
        }

        .text-input {
            font-size: calc(1.275rem + 0.3vw);
            font-weight: 500;
            height: 25px;
            padding: 10px 10px 18px 5px;
            display: block;
            width: 600px;
            border: none;
            outline: none;
            border-bottom: 1px solid #4e7570;
            color: #4e7570;
            background: rgba(0, 0, 0, 0);
            opacity: 1;
            transition: 0.2s ease;
        }

        #getRoute {
            width: 100px;
            border-radius: 10px;
            background-color: #4e7570;
            color: #b1b1b1;
            border-color: #b1b1b1;
            display: inline-block;
            padding-top: 2px;
        }

        .location-input {
            font-size: calc(1.275rem + 0.3vw);
            font-weight: 500;
            height: 25px;
            padding: 10px 10px 18px 5px;
            display: block;
            width: 290px;
            border: none;
            outline: none;
            border-bottom: 1px solid #4e7570;
            color: #4e7570;
            background: rgba(0, 0, 0, 0);
            opacity: 1;
            transition: 0.2s ease;
        }

        .text-address {
            font-size: calc(1.275rem + 0.3vw);
            font-weight: 500;
            height: 25px;
            padding: 10px 10px 18px 5px;
            display: block;
            width: 300px;
            border: none;
            outline: none;
            border-bottom: 1px solid #4e7570;
            color: #4e7570;
            background: rgba(0, 0, 0, 0);
            opacity: 1;
            transition: 0.2s ease;
        }

        .text-input:focus {
            outline: none;
            opacity: 1;
        }

        .cost-input {
            padding-left: 17px;
        }

        .text-label {
            color: #4e7570;
            font-size: 1rem;
            font-weight: normal;
            position: absolute;
            pointer-events: none;
            left: 5px;
            top: 0px;
            opacity: 0.5;
            transition: 0.2s ease all;
            -moz-transition: 0.2s ease all;
            -webkit-transition: 0.2s ease all;
        }

        .other-label {
            color: #4e7570;
            font-size: 1rem;
            font-weight: normal;
            position: absolute;
            opacity: 0.5;
            left: 5px;
            transition: 0.2s ease all;
        }

        .date-label {
            color: #4e7570;
            font-size: 1rem;
            font-weight: normal;
            position: absolute;
            opacity: 0.5;
            left: 5px;
            top: -30px;
            transition: 0.2s ease all;
        }

        .date_alert {
            font-size: 1rem;
            font-weight: normal;
            position: absolute;
            opacity: 0.5;
            left: 45px;
            top: -30px;
        }

        .radio-label {
            color: #4e7570;
            font-size: calc(1.275rem + 0.3vw);
            font-weight: 500;
        }

        .form-check-input {
            margin-top: 10px;
        }

        .datetime-input {
            color: black;
            filter: invert(43%) sepia(18%) saturate(645%) hue-rotate(123deg)
                brightness(91%) contrast(85%);
        }

        .number-input {
            filter: invert(94%) sepia(11%) saturate(369%) hue-rotate(117deg)
                brightness(90%) contrast(91%);
        }

        .currencyinput {
            position: absolute;
            font-size: calc(1.275rem + 0.3vw);
            font-weight: 500;
            color: #4e7570;
            bottom: 2px;
        }

        /* active state */
        .text-input:focus ~ .text-label,
        .text-input:valid ~ .text-label {
            top: -30px;
            font-size: 1rem;
            color: #4e7570;
            opacity: 0.8;
        }

        .highlight {
            position: absolute;
            height: 60%;
            width: 100px;
            top: 25%;
            left: 0;
            pointer-events: none;
            opacity: 0.5;
        }

        .trip {
            transition: 0.2 ease all;
        }

        /* active state */
        input:focus ~ .highlight {
            -webkit-animation: inputHighlighter 0.3s ease;
            -moz-animation: inputHighlighter 0.3s ease;
            animation: inputHighlighter 0.3s ease;
        }

        /* ANIMATIONS ================ */
        @-webkit-keyframes inputHighlighter {
            from {
                background: #b1b1b1;
            }
            to {
                width: 0;
                background: transparent;
            }
        }
        @-moz-keyframes inputHighlighter {
            from {
                background: #b1b1b1;
            }
            to {
                width: 0;
                background: transparent;
            }
        }
        @keyframes inputHighlighter {
            from {
                background: #b1b1b1;
            }
            to {
                width: 0;
                background: transparent;
            }
        }

        .form-check-input:checked {
            background-color: #4e7570;
            border-color: #4e7570;
        }

        .map-styles {
            width: 90%;
            margin: auto;
        }
    </style>
    
    <link rel="stylesheet" href="../../../navbar/nav_styles.css" />
</head>
<body>
    <div id="navbarVue">
        <div v-html="navbar_html" @scroll="nav_animation" data-page="rides"></div>
    </div>

    <div class="text-center my-5">
        <h1>Offer a ride</h1>
    </div>

    <!-- this div section handles the selection between SMU and Location -->
    
    <div class="trip text-center my-3">
        <!-- dropdown list of all the buildings -->
        <h2 class="d-inline" id="location_from">SMU</h2>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="30"
            height="30"
            fill="#4e7570"
            class="bi bi-arrow-right align-text-bottom mx-2"
            viewBox="0 0 16 16"
        >
            <path
                fill-rule="evenodd"
                d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"
            />
        </svg>

        <!-- GET from input -->
        <h2 class="d-inline" id="location_to">Location</h2>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            fill="#4e7570"
            class="bi bi-arrow-repeat align-text-top ms-3"
            viewBox="0 0 16 16"
            onclick="rotate_location()"
        >
            <path
                d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
            />
            <path
                fill-rule="evenodd"
                d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
            />
        </svg>
    </div>

    <div class="content d-flex justify-content-center text-align-center">
        <form action="../rides_list/rides_listing.html" class="d-inline-block my-3">
            <!-- get the input from the user from here -->
            <div class="row d-flex justify-content-center my-2">
                <div class="col-md-6 d-flex justify-content-center py-3">
                    <div class="wheresmu px-auto">
                        <label for="smubuildings">SMU </label>
                        <select
                            name="smubuildings"
                            id="smulocation"
                            onchange="getSMUloc('gohome')"
                        >
                            <option value="Singapore 178902">SCIS</option>
                            <option value="Singapore 178903">SOE</option>
                            <option value="Singapore 179943">SOL</option>
                            <option value="Singapore 178900">SOA</option>
                            <option value="Singapore 178899">SOB</option>
                            <option value="Singapore 179873">SOSS</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-6 d-flex justify-content-center py-3">
                    <div class="group">
                        <input type="text" name="address" class="location-input" id="location_field" required/>
                        <span class="highlight"></span>
                        <!-- <label class="text-label">Drop off address</label> -->
                    </div>
                </div>
            </div>
            <div class="row d-flex justify-content-center">

                <input type="button" id="getRoute" value="Find route!" class="btn button w-25 d-block align-center" onclick="calcRoute()">
                <br>
                <p id="display" class="lead text-center"></p> 
            </div>

            

            <div id="map"></div>
            <!-- <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>  -->
            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAv4TSlT_Tm-4Pi6x6_bkUZKgsfr_iFe5Q&callback=initMap" type="text/javascript" async defer></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
            
            <div id="problematic"></div>
            <script>
        
            var map;
            function initMap() {
                
                map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: coords[0], lng: coords[1]},
                zoom: 17, 
                mapTypeControl: false,
                //mapTypeID: google.maps.mapTypeID
                });

                marker = new google.maps.Marker({
                    map,
                    draggable: true,
                    animation: google.maps.Animation.DROP,
                    position: {lat: coords[0], lng: coords[1]},
                    preserveViewport: true
                  });
            }
            //directionsDisplay
            var chosenloc = document.getElementById('location_field').value
            console.log(chosenloc)
            var chosentrans = encodeURI(chosenloc)
            
            smuLatLng = []
            coords = [1.296568, 103.852119] // auto starts center at SCIS

            
            // directionservice allows use of route method, directionrenderer displays the route

            // creates the map

            function getSMUloc() {
                var smuloc = document.getElementById('smulocation').value
                var smutrans = smuloc.replace(' ', '%20')

                var url = "https://maps.googleapis.com/maps/api/geocode/json?address=" + smutrans + "&key=AIzaSyAv4TSlT_Tm-4Pi6x6_bkUZKgsfr_iFe5Q";

                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    // console.log(this.readyState, this.status)
                    if (this.readyState == 4 && this.status == 200) {
                        try {
                            var data = JSON.parse(this.responseText);
                            
                            console.log(smutrans)
                            var location = data["results"][0]['geometry']['location'];
                            console.log(location)
                            smuLatLng = [location['lat'],location['lng']]
                            console.log(smuLatLng)

                            
                            coords = [smuLatLng[0], smuLatLng[1]]
                        
                            initMap();

                        } catch(err) {
                            document.getElementById('display').innerHTML = "Sorry, invalid address. Please try a valid address!";
                        }
                    } 
                    else if (this.readyState != 4 || this.status != 200){
                        
                    }
                }
                xhttp.open("GET", url, true);
                xhttp.send();
            }

            function calcRoute() 
            {
                if (smu_position == 'from')
                {
                    var request = 
                    {
                        origin: document.getElementById('smulocation').value,
                        destination: document.getElementById('location_field').value,
                        travelMode: google.maps.TravelMode['DRIVING'],
                        unitSystem: google.maps.UnitSystem['METRIC']
                    }
                    console.log("is it working???")
                }

                else 
                {
                    var request = 
                    {
                    origin: document.getElementById('location_field').value,
                    destination: document.getElementById('smulocation').value,
                    travelMode: google.maps.TravelMode['DRIVING'], 
                    unitSystem: google.maps.UnitSystem['METRIC'],
                    }
                }

                var directionsService = new google.maps.DirectionsService();
                var directionsDisplay = new google.maps.DirectionsRenderer();

                directionsDisplay.setOptions({
                    polylineOptions: {
                      strokeColor: 'green'
                    }
                  });

                directionsService.route(request, function(result, status) {
                    if (status == "OK") 
                    {
                         
                        // this gets distance and time taken for route
                        const output = document.querySelector('#problematic');

                        // from smu to indicated location, display route and duration
                        if (smu_position == 'from') 
                        {
                            output.innerHTML = `<div class='alert-info'> From: ${document.getElementById('smulocation').value} <br>To: ${document.getElementById('location_field').value}<br>Driving distance: ${result.routes[0].legs[0].distance.text}<br>Duration: ${result.routes[0].legs[0].duration.text}</div>`
                            marker.setMap(null)
                            directionsDisplay.setMap(null)
                            directionsDisplay.setDirections({routes: []});

                            directionsDisplay.setDirections(result);
                            directionsDisplay.setMap(map);
                        }
                        // from indicated to smu, display route and duration
                        else 
                        {
                            output.innerHTML = `<div class='alert-info'> From: ${document.getElementById('location_field').value} <br>To: ${document.getElementById('smulocation').value}<br>Driving distance: ${result.routes[0].legs[0].distance.text}<br>Duration: ${result.routes[0].legs[0].duration.text}</div>`

                            marker.setMap(null)
                            directionsDisplay.setMap(null)
                            directionsDisplay.setDirections({routes: []});

                            directionsDisplay.setDirections(result);
                            directionsDisplay.setMap(map);
                            
                        }
                    }

                    else 
                    {
                        directionsDisplay.setDirections({routes: []});

                        map.setCenter(coords[0], coords[1])

                        // error message for invalid address
                        output.innerHTML = `<div class='alert-danger'>Stop it. Get some help.</div>`
                    }
                })
            }
            // autocomplete objects for all input
      
            var options = 
            {
                types: ['(cities)']
            }

             var input1 = document.getElementById('smulocation')
             var autocomplete1 = new google.maps.places.Autocomplete(input1, options)

             var input2 = document.getElementById('location_field')
             var autocomplete2 = new google.maps.places.Autocomplete(input2, options);
            
            </script>
                
                <div class="group" id="cost_group">  
                    <span class="currencyinput" id="dollarsign"></span>    
                    <input type="number" name='cost' min="0" step="0.1" class="text-input cost-input" oninput="cost_click()" required>
                    <span class="highlight"></span>
                    <label class="text-label">Cost per person</label>

                </div>
                <div class="group">
                    <input type="number" name="capacity" min="0" max="10" class="text-input" required>
                    <span class="highlight"></span>
                    <label class="text-label">Seat capacity per ride</label>
                </div>
                <div class="other-group">      
                    <label class="other-label" id="frequency-label">Frequency</label><br>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="frequency" value="adhoc" id="frequency-adhoc" onclick="frequency_click()">
                        <label class="form-check-label radio-label" for="frequency-adhoc">Ad-hoc</label><br>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="frequency" value="recurring" id="frequency-recurring" onclick="frequency_click()">
                        <label class="form-check-label radio-label" for="frequency-recurring">Recurring</label> 
                    </div>
                </div>
                <div class="group">      
                    <input type="date" name="date" class="text-input datetime-input" oninput="date_click()" v-model="date" required>
                    <span class="highlight"></span>
                    <label class="date-label" id="date-label">Date</label>
                    <label class="date_alert text-danger" role="alert" v-if="check_date()">
                        please select a date not more than 1 year from today *
                    </label>
                </div>
                <div class="group">      
                    <input type="time" name="time" class="text-input datetime-input" oninput="time_click()" required>
                    <span class="highlight"></span>
                    <label class="date-label" id="time-label">Time</label>
                </div>
                <button
                    type="submit"
                    class="btn button d-block mx-auto mt-5 w-100 mb-5"
                    id = "rides"
                >
                    Get in loser, we're going shopping.
                </button>
        </form>
    </div>

</body>

<script>
    username = "bob"
    email = 'bob@hello.com' // this username can be read in the riders_indiv_driver.js file 
</script>

<script type="module" src="../../../index.js"></script>
<script type="module" src="./rides_indiv_driver.js"></script>

    <script>
        smu_position = "from";

        function frequency_click() {
            document.getElementById("frequency-label").style = "opacity:0.8";
        }
        
        function date_click() {
            document.getElementById("date-label").style = "opacity:0.8";
        }

        function time_click() {
            document.getElementById("time-label").style = "opacity:0.8";

        }

        function cost_click() {
            document.getElementById("dollarsign").innerHTML = "$";
        }

        function rotate_location() {
            if (smu_position == "from") {
                document.getElementById("location_from").innerHTML = "Location";
                document.getElementById("location_to").innerHTML = "SMU";
                document.getElementById("location_field").innerHTML =
                    "Pick up address";
                smu_position = "to";
            } else {
                document.getElementById("location_from").innerHTML = "SMU";
                document.getElementById("location_to").innerHTML = "Location";
                document.getElementById("location_field").innerHTML =
                    "Drop off address";
                smu_position = "from";
            }
        }
        console.log(document.getElementsByTagName('input'))
    </script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="../../../navbar/navbar.js"></script>
    
</body>
